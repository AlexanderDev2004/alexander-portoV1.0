---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export const prerender = true;

export async function getStaticPaths() {
  const blogEntries = await getCollection('blogs');
  return blogEntries.map((entry) => ({
    params: { slug: entry.slug },
  }));
}

const blogEntries = await getCollection('blogs');
const blog = blogEntries.find((entry) => entry.slug === Astro.params.slug);

if (!blog) {
  throw new Error(`Blog post not found: ${Astro.params.slug}`);
}

const { Content } = await blog.render();

// GitHub edit link
const githubRepo = 'AlexanderDev2004/alexanderar.com';
const githubBranch = 'master';
const editLink = `https://github.com/${githubRepo}/edit/${githubBranch}/src/content/blogs/${Astro.params.slug}.md`;
---

<Layout>
  <div class="reading-progress" aria-hidden="true">
    <div class="reading-progress__bar" id="readingProgressBar"></div>
  </div>
  <div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Back Button -->
    <a
      href="/all-blogs"
      class="text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white flex items-center gap-2 font-medium mb-8 transition-colors"
    >
      <iconify-icon icon="mdi:arrow-left" width="20" height="20"></iconify-icon>
      Back to Posts
    </a>

    <!-- Header -->
    <article class="space-y-6 expand-reveal">
      <header class="space-y-4 border-b border-gray-200 dark:border-gray-700 pb-8">
        <div class="flex items-start justify-between gap-4">
          <h1 class="text-4xl font-bold text-gray-900 dark:text-white flex-1">
            {blog.data.title}
          </h1>
          <a
            href={editLink}
            target="_blank"
            rel="noopener noreferrer"
            title="Edit this post on GitHub"
            class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors whitespace-nowrap"
          >
            <iconify-icon icon="mdi:github" width="18" height="18"></iconify-icon>
            <span class="hidden sm:inline">Edit</span>
          </a>
        </div>

        <div class="flex items-center gap-4 text-gray-600 dark:text-gray-400">
          <div class="flex items-center gap-2">
            <iconify-icon icon="mdi:calendar" width="18" height="18"></iconify-icon>
            <span>
              {blog.data.date.toLocaleDateString('en-US', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
              })}
            </span>
          </div>
        </div>

        <!-- Tags -->
        {blog.data.tags && blog.data.tags.length > 0 && (
          <div class="flex flex-wrap gap-2 pt-4">
            {blog.data.tags.map((tag) => (
              <span class="bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-full text-sm font-medium">
                #{tag}
              </span>
            ))}
          </div>
        )}
      </header>

      <!-- Content -->
      <div class="prose dark:prose-invert max-w-none">
        <Content />
      </div>

      <!-- Footer -->
      <footer class="border-t border-gray-200 dark:border-gray-700 pt-8 mt-12">
        <a
          href="/all-blogs"
          class="text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white font-medium transition-colors"
        >
          ‚Üê Back to All Posts
        </a>
      </footer>
    </article>
  </div>
  <script is:inline>
    const progressBar = document.getElementById('readingProgressBar');
    const updateProgress = () => {
      if (!progressBar) return;
      const scrollTop = window.scrollY || document.documentElement.scrollTop;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const progress = docHeight > 0 ? Math.min(scrollTop / docHeight, 1) : 0;
      progressBar.style.transform = `scaleX(${progress})`;
    };

    let ticking = false;
    const onScroll = () => {
      if (ticking) return;
      ticking = true;
      window.requestAnimationFrame(() => {
        updateProgress();
        ticking = false;
      });
    };

    updateProgress();
    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', updateProgress);
  </script>
</Layout>

<style>
  .reading-progress {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: rgba(148, 163, 184, 0.2);
    z-index: 60;
  }

  .reading-progress__bar {
    height: 100%;
    width: 100%;
    transform: scaleX(0);
    transform-origin: left;
    background: linear-gradient(90deg, #38bdf8, #3b82f6);
    transition: transform 0.08s ease-out;
  }

  :global(html.dark) .reading-progress {
    background: rgba(148, 163, 184, 0.18);
  }
</style>
